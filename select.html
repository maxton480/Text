<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Select Images</title>
  <style>
    body{font-family:Arial;background:#020617;color:#e5e7eb;margin:0}
    .wrap{max-width:1100px;margin:20px auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
    .item{position:relative;border-radius:14px;overflow:hidden;border:2px solid transparent}
    .item img{width:100%;height:160px;object-fit:cover}
    .item input{position:absolute;top:10px;left:10px;transform:scale(1.4)}
    .item.sel{border-color:#22c55e}
    button{padding:10px 14px;border-radius:12px;border:none;cursor:pointer;background:#22c55e;color:#022c22;font-weight:bold}
    .top{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .muted{color:#94a3b8;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <button onclick="selectAll()">Select All</button>
      <button onclick="next()">Download Selected</button>
      <span class="muted" id="status"></span>
    </div>
    <div id="grid" class="grid"></div>
  </div>

  <script>
    const target = localStorage.getItem('targetURL');
    const proxy = localStorage.getItem('proxyURL') || '';
    const grid = document.getElementById('grid');
    const status = document.getElementById('status');
    let images = [];

    async function load(){
      if(!target){ alert('No URL'); location.href='index.html'; return; }
      status.textContent = 'Fetching pageâ€¦';
      try{
        const res = await fetch(proxy + target);
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html,'text/html');
        const imgs = Array.from(doc.images).map(i=>i.src).filter(Boolean);
        images = [...new Set(imgs)];
        status.textContent = `Found ${images.length} images`;
        render();
      }catch(e){
        status.textContent = 'Error. Try CORS proxy.';
      }
    }

    function render(){
      grid.innerHTML='';
      images.forEach((src,i)=>{
        const d=document.createElement('div'); d.className='item';
        d.innerHTML = `<img src="${src}"><input type="checkbox" data-i="${i}">`;
        const cb=d.querySelector('input');
        cb.onchange=()=>d.classList.toggle('sel',cb.checked);
        grid.appendChild(d);
      });
    }
    function selectAll(){
      document.querySelectorAll('.item input').forEach(cb=>{cb.checked=true;cb.dispatchEvent(new Event('change'))});
    }
    function next(){
      const sel = Array.from(document.querySelectorAll('.item input:checked')).map(cb=>images[cb.dataset.i]);
      if(!sel.length) return alert('Select images first');
      localStorage.setItem('selectedImages', JSON.stringify(sel));
      location.href='download.html';
    }
    load();
  </script>
</body>
</html>
